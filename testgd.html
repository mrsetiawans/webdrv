<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upgrade Google Drive & Photos Unlimited - Penawaran Spesial!</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Google_Drive_icon_%282020%29.svg/330px-Google_Drive_icon_%282020%29.svg.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '630583642253416');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=630583642253416&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->

    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --secondary: #F5F5F7;
            --text-main: #1D1D1F;
            --text-secondary: #86868B;
            --success: #34C759;
            --error: #FF3B30;
            --border: #D2D2D7;
            --bg-page: #FBFBFD;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Modern Card & Layout */
        .main-container {
            max-width: 520px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 40px rgba(0,0,0,0.05);
        }

        @media (min-width: 640px) {
            .main-container {
                min-height: auto;
                margin: 40px auto;
                border-radius: 24px;
                border: 1px solid rgba(0,0,0,0.05);
            }
            body {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                padding-bottom: 40px;
            }
        }

        /* Glassmorphism Header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Inputs */
        .input-group {
            position: relative;
            margin-bottom: 16px;
        }
        
        .modern-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            border: 1px solid var(--border);
            border-radius: 12px;
            outline: none;
            transition: all 0.2s ease;
            background: #F5F5F7;
            color: var(--text-main);
        }

        .modern-input:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .input-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Package Selection Cards */
        .package-card {
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .package-card.selected {
            border-color: var(--primary);
            background: #F0F7FF;
            cursor: default;
        }

        .package-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #C7C7CC;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .package-card.selected .package-check {
            background: var(--primary);
            border-color: var(--primary);
        }

        .package-check::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 10px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
        }

        .package-card.selected .package-check::after {
            opacity: 1;
            transform: scale(1);
        }

        /* Payment Grid */
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .payment-option {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            height: 70px;
            position: relative;
        }

        .payment-option:hover {
            border-color: #b0b0b5;
            background: #fafafa;
        }

        .payment-option.selected {
            border-color: var(--primary);
            background: #F0F7FF;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
        }

        .payment-option img {
            height: 24px;
            width: auto;
            object-fit: contain;
            margin-bottom: 4px;
        }
        
        .payment-option span {
            font-size: 10px;
            color: var(--text-main);
            font-weight: 500;
            text-align: center;
        }

        /* Checkout Button */
        .btn-checkout {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-checkout:active {
            transform: scale(0.98);
        }
        
        .btn-checkout:disabled {
            background: #B0B0B5;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Features List */
        .feature-item {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-main);
            line-height: 1.5;
        }

        .feature-icon {
            color: var(--success);
            margin-top: 3px;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: max-content;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Testimonial Carousel (Marquee) */
        .testimonial-carousel {
            overflow: hidden;
            width: 100%;
            position: relative;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        
        .testimonial-track {
            display: flex;
            gap: 12px;
            width: max-content;
            animation: marquee 40s linear infinite;
            padding: 4px 0; /* space for shadow/border */
        }

        .testimonial-track:hover {
            animation-play-state: paused;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .testimonial-item {
            flex-shrink: 0;
            width: 140px;
            height: 140px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .testimonial-item:hover {
            transform: scale(1.02);
        }

        .testimonial-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* FAQ Accordion */
        .faq-item {
            border-bottom: 1px solid var(--border);
        }
        .faq-item:last-child {
            border-bottom: none;
        }
        .faq-item summary {
            padding: 16px 0;
            cursor: pointer;
            font-weight: 500;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .faq-item summary::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.2s;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .faq-item[open] summary::after {
            transform: rotate(180deg);
        }
        .faq-content {
            padding-bottom: 16px;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-box {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-box {
            transform: scale(1);
        }
        
        /* Details Modal (Bottom Sheet style) */
        #detailsModal {
             align-items: flex-end;
        }
        #detailsModal .modal-box { /* Override default modal-box for bottom sheet */
            width: 100%;
            max-width: 520px; /* Match main container width */
            margin: 0 auto;
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #detailsModal.active .modal-box {
            transform: translateY(0);
        }
        
        /* Payment Instruction Styles */
        .instruction-step {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .step-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .copy-btn {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary);
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* New Card & Sheet Styles */

        /* Bottom sheet animation */
        .sheet-backdrop { opacity: 0; transition: opacity .18s ease; }
        .sheet-panel { transform: translateY(14px); opacity: 0; transition: transform .22s ease, opacity .22s ease; }
        .sheet-open .sheet-backdrop { opacity: 1; }
        .sheet-open .sheet-panel { transform: translateY(0); opacity: 1; }

        /* prevent overscroll bounce inside sheet */
        .no-bounce { overscroll-behavior: contain; }
    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="toast" class="toast">
        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 flex-shrink-0">
            <i class="fas fa-check"></i>
        </div>
        <div class="text-sm">
            <p class="font-semibold text-gray-900" id="toast-name">Budi Santoso</p>
            <p class="text-gray-500 text-xs">Baru saja membeli paket 2TB Lifetime</p>
        </div>
    </div>

    <div class="main-container relative">
        <!-- Main Form View -->
        <div id="view-form">
            <!-- Header -->
            <div class="sticky-header px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Google_Drive_icon_%282020%29.svg/330px-Google_Drive_icon_%282020%29.svg.png" alt="Google Drive Logo" class="w-8 h-8">
                    <div>
                        <h1 class="font-bold text-lg leading-none">Google Drive</h1>
                        <p class="text-xs text-gray-500 font-medium">Official Upgrade</p>
                    </div>
                </div>
                <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-semibold">
                    <i class="fas fa-check-circle mr-1"></i> Garansi Resmi
                </div>
            </div>

            <div class="p-6 pb-24">
                <!-- Hero / Product Info -->
                <div class="text-center mb-8 animate-fade-in">
                    <span class="inline-block bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold mb-3 animate-pulse">
                        ðŸ”¥ PROMO TERBATAS
                    </span>
                    <h2 class="text-2xl font-bold mb-2">Upgrade Penyimpanan Google</h2>
                    <p class="text-gray-500 text-sm px-4">Sekali bayar, aktif seumur hidup (Lifetime) di akun sendiri. Legal & Aman.</p>
                </div>

                <!-- Form -->
                <form id="orderForm" class="space-y-6">
                    
                    <!-- Package Selection -->
                    <div class="space-y-3 animate-fade-in" style="animation-delay: 0.1s">
                        <div id="package-selection-container" class="space-y-3">
                            <!-- Package cards will be rendered here by JavaScript -->
                        </div>
                        <input type="hidden" id="selectedPackage" name="package" value="lifetime">
                    </div>

                    <!-- Testimonials -->
                    <div class="animate-fade-in" style="animation-delay: 0.18s">
                        <label class="text-sm font-semibold text-gray-700 ml-1 mb-2 block">Bukti Pelanggan</label>
                        <div class="testimonial-carousel" id="testimonial-container">
                            <!-- Filled by JS -->
                        </div>
                    </div>

                    <!-- User Data -->
                    <div class="space-y-4 animate-fade-in" style="animation-delay: 0.2s">
                        <label class="text-sm font-semibold text-gray-700 ml-1">Data Pemesan</label>
                        
                        <div class="input-group">
                            <input type="text" id="nama" name="nama" class="modern-input" placeholder="Nama Lengkap" required>
                            <i class="fas fa-user input-icon"></i>
                        </div>
                        
                        <div class="input-group">
                            <input type="tel" id="whatsapp" name="whatsapp" class="modern-input" placeholder="Nomor WhatsApp (08xx)" required inputmode="numeric">
                            <i class="fab fa-whatsapp input-icon"></i>
                        </div>

                        <div class="input-group">
                            <input type="email" id="email" name="email" class="modern-input" placeholder="Email Gmail (untuk di-upgrade)" required>
                            <i class="fas fa-envelope input-icon"></i>
                        </div>
                    </div>

                    <div class="bg-red-50 border-l-4 border-red-600 p-3 my-4 rounded-r-lg shadow-sm flex items-center gap-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-xl text-red-600 animate-pulse"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-red-700 text-sm uppercase">PENTING: Cek Kembali Data Anda!</h3>
                            <p class="text-sm text-gray-700 leading-tight mt-0.5">
                                Pastikan <strong>No. WhatsApp</strong> & <strong>Email</strong> yang Anda masukkan sudah <strong>BENAR</strong> dan <strong>AKTIF</strong>.
                            </p>
                        </div>
                    </div>

                    <!-- Hidden Fields -->
                    <input type="text" name="honeypot" style="display: none" tabindex="-1" autocomplete="off">
                    <input type="hidden" name="sheetName" value="gdrive">

                    <!-- Payment Method -->
                    <div class="space-y-3 animate-fade-in" style="animation-delay: 0.25s">
                        <label class="text-sm font-semibold text-gray-700 ml-1">Metode Pembayaran</label>
                        <div class="payment-grid" id="payment-grid">
                            <!-- Generated by JS -->
                        </div>
                        <input type="hidden" id="selectedPayment" name="payment-method" value="qris">
                    </div>

                </form>

                <!-- FAQ Section -->
                <div class="mt-8 animate-fade-in" style="animation-delay: 0.3s">
                    <h3 class="font-bold text-gray-900 mb-4">Pertanyaan Umum (FAQ)</h3>
                    <div id="faq-container">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Trust Badges -->
                <div class="mt-8 flex justify-center gap-4 opacity-50 grayscale hover:grayscale-0 transition-all duration-300">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo_QRIS.svg/1200px-Logo_QRIS.svg.png" class="h-6">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Bank_Central_Asia.svg/1200px-Bank_Central_Asia.svg.png" class="h-6">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Gopay_logo.svg/1200px-Gopay_logo.svg.png" class="h-6">
                </div>
                
                <p class="text-center text-xs text-gray-400 mt-8">Â© 2026 Google Drive. All Rights Reserved.</p>
            </div>

            <!-- Sticky Bottom Bar -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-40 sm:absolute sm:rounded-b-3xl">
                <div class="max-w-[520px] mx-auto flex items-center justify-between gap-4">
                    <div>
                        <p class="text-xs text-gray-500">Total Pembayaran</p>
                        <p class="text-xl font-bold text-blue-600" id="total-price-display">Rp 250.xxx</p>
                    </div>
                    <button type="button" id="submit-btn" class="btn-checkout flex-1" onclick="handleFormSubmit()">
                        Beli Sekarang <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Instruction View (Hidden by default) -->
        <div id="view-payment" class="hidden min-h-screen bg-gray-50 sm:rounded-3xl overflow-hidden">
             <div class="bg-white p-4 sticky top-0 z-10 border-b flex items-center gap-3 shadow-sm">
                <button onclick="backToForm()" class="text-gray-500 hover:text-black">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h2 class="font-bold text-lg">Instruksi Pembayaran</h2>
            </div>

            <div class="p-6 pb-24">
                <!-- Timer -->
                <div class="bg-blue-600 text-white rounded-xl p-4 text-center mb-6 shadow-lg shadow-blue-200">
                    <p class="text-xs opacity-80 mb-1">Selesaikan pembayaran dalam</p>
                    <div class="text-2xl font-bold font-mono" id="countdown">23:59:59</div>
                </div>

                <!-- Total Amount Card -->
                <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm mb-6 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gray-200"></div>
                    <p class="text-gray-500 text-sm mb-1">Total yang harus dibayar</p>
                    <div class="flex items-center justify-center gap-2 mb-2">
                         <h1 class="text-3xl font-bold text-gray-900" id="payment-amount">Rp 250.123</h1>
                         <button class="copy-btn" onclick="copyText('payment-amount-raw')"><i class="far fa-copy"></i></button>
                    </div>
            <p class="text-xs text-red-500 bg-red-50 inline-block px-2 py-1 rounded mb-4">
                        <i class="fas fa-exclamation-circle"></i> Transfer tepat hingga 3 digit terakhir
                    </p>
             <div id="invoice-details-summary" class="border-t border-gray-100 pt-3 text-xs text-gray-500 flex justify-between items-center">
                <!-- Populated by JS -->
             </div>
                </div>

                <!-- Payment Details -->
                <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm mb-6">
                    <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
                        <span class="text-gray-500 text-sm">Metode</span>
                        <img id="payment-logo-result" src="" class="h-6 object-contain">
                    </div>
                    
                    <!-- Dynamic Content based on Payment Method -->
                    <div id="payment-details-content">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Instructions -->
                <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-900 mb-4">Langkah Pembayaran</h3>
                    <div id="instruction-steps">
                        <!-- Filled by JS -->
                    </div>
                </div>
                
                <!-- OCR Payment Verification -->
                <div id="ocr-container" class="mt-8 bg-white border-2 border-dashed border-blue-200 rounded-xl p-6 text-center hover:bg-blue-50 transition-colors cursor-pointer relative overflow-hidden group" onclick="document.getElementById('payment-proof-input').click()">
                    <h3 class="font-bold text-gray-900 mb-2">Verifikasi Pembayaran</h3>
                    
                    <input type="file" id="payment-proof-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    
                    <!-- Initial State -->
                    <div id="ocr-initial-state">
                        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-2xl"></i>
                        </div>
                        <p class="text-sm font-semibold text-gray-700">Klik untuk Upload Bukti Transfer</p>
                        <p class="text-xs text-gray-400 mt-1">Sistem akan memverifikasi pembayaran anda secara otomatis.</p>
                    </div>

                    <!-- Scanning State -->
                    <div id="ocr-scanning-state" class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center z-10">
                        <div class="relative w-16 h-16 mb-4">
                             <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
                             <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
                             <div class="absolute inset-0 flex items-center justify-center text-blue-600">
                                <i class="fas fa-search"></i>
                             </div>
                        </div>
                        <p class="text-sm font-semibold text-blue-600 animate-pulse">Memverifikasi Bukti...</p>
                    </div>

                </div>

                <!-- Confirmation Button -->
                <a id="wa-confirm-btn" href="#" target="_blank" class="block mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl text-center shadow-lg shadow-green-200 transition-all">
                    <i class="fab fa-whatsapp text-lg mr-2"></i> Konfirmasi Manual (WA)
                </a>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay" onclick="closeModal('detailsModal')">
        <div class="modal-box text-left p-0" id="detailsModalContent" onclick="event.stopPropagation()">
            <!-- Content will be injected by JS -->
        </div>
    </div>

    <!-- DETAIL BOTTOM SHEET -->
    <div id="sheet" class="fixed inset-0 z-[60] hidden" aria-hidden="true">
      <div id="sheetBackdrop" class="sheet-backdrop absolute inset-0 bg-slate-900/40 backdrop-blur-[2px]"></div>

      <div class="absolute inset-x-0 bottom-0 mx-auto max-w-xl px-4 pb-[calc(14px+env(safe-area-inset-bottom))]">
        <div id="sheetPanel"
          class="sheet-panel no-bounce overflow-hidden rounded-3xl bg-white shadow-[0_24px_90px_-45px_rgba(2,6,23,.65)] ring-1 ring-slate-200"
          role="dialog" aria-modal="true" aria-labelledby="sheetTitle">

          <div class="flex items-center justify-between p-4">
            <div class="min-w-0">
              <p class="text-[11px] font-semibold tracking-wider text-slate-500">DETAIL PAKET</p>
              <h4 id="sheetTitle" class="mt-0.5 truncate text-base font-extrabold text-slate-900">Yang kamu dapat</h4>
            </div>

            <button id="btnClose" type="button"
              class="grid h-10 w-10 place-items-center rounded-2xl bg-slate-50 text-slate-700 ring-1 ring-slate-200 active:scale-[.98]"
              aria-label="Tutup">âœ•</button>
          </div>

          <div class="px-4 pb-4">
            <ul id="sheet-features-list" class="space-y-2 text-sm text-slate-700">
                <!-- Populated by JS -->
            </ul>

            <button id="btnOk" type="button"
              class="mt-4 h-12 w-full rounded-2xl bg-[#1a73e8] text-sm font-semibold text-white active:scale-[.99]">
              Oke, Mengerti
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- OCR Success Modal -->
    <div id="ocrSuccessModal" class="modal-overlay">
        <div class="modal-box">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-5 text-4xl shadow-sm">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-gray-900">Pembayaran Berhasil!</h3>
            <p class="text-gray-500 mb-8 px-4 text-sm leading-relaxed">Terima kasih! Bukti pembayaran Anda telah diverifikasi. Pesanan Anda sedang diproses dan akan segera dikirim.</p>
            <button onclick="closeModal('ocrSuccessModal')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl transition-colors shadow-lg shadow-green-200">Tutup</button>
        </div>
    </div>

    <!-- OCR Failure Modal -->
    <div id="ocrFailureModal" class="modal-overlay">
        <div class="modal-box">
            <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-5 text-4xl shadow-sm">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-gray-900">Verifikasi Gagal</h3>
            <p class="text-gray-500 mb-8 px-4 text-sm leading-relaxed" id="ocrFailureMsg">Bukti pembayaran tidak valid atau tidak terbaca. Silakan upload ulang bukti yang jelas.</p>
            <div class="flex flex-col gap-3">
                <button onclick="retryOCRUpload()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition-colors shadow-lg shadow-blue-200">Coba Upload Lagi</button>
                <button onclick="closeModal('ocrFailureModal')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3.5 rounded-xl transition-colors">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-box">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fas fa-info"></i>
            </div>
            <h3 class="text-xl font-bold mb-2" id="modalTitle">Judul</h3>
            <p class="text-gray-500 mb-6" id="modalMessage">Pesan</p>
            <button onclick="closeModal('infoModal')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Mengerti</button>
        </div>
    </div>

    <!-- Features Modal -->
    <div id="featuresModal" class="modal-overlay">
        <div class="modal-box text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Detail Fitur</h3>
                <button onclick="closeModal('featuresModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2" id="features-list-container">
                <!-- Features filled by JS -->
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal-overlay" onclick="closeModal('imageModal')">
        <div class="relative max-w-[90%] max-h-[90vh]">
             <img id="modalImageDisplay" src="" class="rounded-xl shadow-2xl max-h-[80vh] w-auto">
             <button class="absolute top-4 right-4 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center" onclick="closeModal('imageModal')">&times;</button>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        // PENTING: GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbySaAB2WT0D59UlLyZcXliWvNURCnHcRrqz5P8C2LCQbVdk0hn3Qkl1glGiLJSql_Wh/exec';
        
        const uniqueCode = Math.floor(Math.random() * (500 - 100 + 1)) + 100;
        
        // RESTORED DATA
        const FIRST_NAMES = [ "Budi Santoso", "Ayu", "Rahmat", "Citra Dewi Kusuma", "Bayu Pratama", "Lina", "Wulan", "Adi", "Farhan Syahputra", "Hendra Wijaya", "Nana Puspita Dewi", "Joko", "Mega Sari", "Gilang Pramana Putra", "Sari", "Dedi", "Eka Suryani", "Teguh", "Putri Lestari Ayu", "Andi", "Bagus Wijaya", "Ilham Saputra Nugraha", "Rizal", "Mira Astuti", "Puspita", "Hari", "Tri Saputra", "Cahya Pratama", "Surya Darmawan Putra", "Wahyu Ramadhan", "Agus", "Indra Permana", "Linda", "Fajar Mahendra Saputra", "Yusuf", "Pramono Adi Nugroho", "Sinta Dewi", "Bima Pratama", "Dian", "Hasan Basri", "Nurul Aini", "Arif Budiman", "Feri", "Lukman Hakim", "Rangga", "Rini Anggraini Putri", "Tono", "Hadi Prasetyo", "Elisa Purnama", "Anisa Rahma", "Gunawan", "Melati", "Bagus Prasetyo Ramadhan", "Septi Amelia", "Cindy Amelia", "Windi Saputri", "Galih Pratama", "Evi", "Putra", "Slamet Riyadi", "Latif Hidayat", "Gita Puspita", "Darmawan", "Maya", "Erik Saputra Pratama", "Jani", "Jefri Maulana", "Bella Sari", "Maulana", "Novi Andriana Lestari", "Fajar Nugroho", "Taufik Hidayat", "Prasetyo", "Samsul", "Agung", "Endang", "Indah", "Hana Pertiwi", "Mirna", "Yulia", "Panca", "Niken", "Rio", "Adi Putra Ramadhan", "Ganda", "Wahida", "Robby Saputra", "Halim", "Firman Saputra", "Berlian Putra", "Ari", "Joko Setiawan", "Mustika", "Bahar", "Mega", "Erlangga", "Sofyan", "Doni", "Fatimah", "Dian Purnama Sari", "Rama", "Imam Saputra", "Johan", "Gusman", "Lintang", "Nabila", "Beni", "Purnama", "Murni", "Malik", "Nurlan", "Doni Saputra", "Lastri", "Berlinda", "Rasyid", "Tari", "Nia", "Tirta", "Juli Andriani", "Lutfi", "Suci", "Arman", "Yani", "Citra Ayu", "Harto", "Rangga Pratama", "Febrina", "Indra Gunawan Saputra", "Tomi", "Sutrisno", "Risma", "Jihan Ayu Pratiwi", "Lestari", "Dewi Kusuma", "Fahmi", "Rifki", "Wira", "Putra Wijaya", "Beni Setiawan", "Asep", "Gerry", "Prasetia", "Euis", "Latif", "Pajar", "Rahmat Hidayat", "Rudi", "Tika", "Danu", "Hesti", "Syahrul", "Anwar", "Miranti", "Nuraini", "Nurman", "Eman Kurnia", "Nirmala", "Hari Susanto", "Taufan", "Tono Prabowo", "Bayu Saputra Nugroho", "Darma", "Nurlaila", "Hafid", "Mustofa", "Elok", "Gunarto", "Novi", "Lasman", "Jamaludin", "Andi Wijaya Putra", "Herman", "Mila", "Wibowo", "Prayitno", "Adi Saputra", "Jamal", "Irfan", "Iskandar", "Yudha", "Lutris", "Samsul Hidayat", "Heru", "Bagus", "Rudianto", "Nanda Putri", "Laila Rahma", "Frans", "Hilda", "Cahya", "Rudi Pratama", "Setiawan", "Rangga Saputra", "Puspa", "Doni Prasetyo", "Nurul", "Febri", "Mega Sari Lestari", "Suyatno", "Tomiadi", "Fikri", "Lani", "Intan", "Johan Saputra", "Iwan", "Berliano", "Ilham", "Teddy", "Lani Puspita", "Eka Putri Andayani", "Hani", "Adi Wijaya", "Adit", "Dicky", "Gopal", "Pramono", "Gunadi", "Gilang", "Joko Prayitno Adi", "Mira", "Puspita Sari", "Maulana Hakim", "Putri Ayu Lestari", "Malik Prasetyo", "Toriq", "Joni", "Gilang Pratama", "Bagus Wijaya Putra", "Berlian", "Wandi", "Nurman Saputra", "Fajarudin", "Lutfi Pratama", "Citra", "Nanda", "Laras", "Tuti", "Yani Pratiwi", "Gusman Saputra", "Rangga Putra", "Prasetiawan", "Ismail", "Heri", "Adi Nugroho", "Putri", "Prasetyo Adi", "Dona", "Gani", "Jihan", "Puspita Dewi", "Rizal Maulana", "Mahendra", "Ayu Pratiwi", "Rangga Setiawan", "Lina Sari", "Fani", "Adi Wijaya Putra", "Sari Melati", "Andri", "Bima", "Teguh Santoso Adi", "Fajar", "Wulan Dewi", "Rama Pratama", "Nana", "Farhan", "Dion", "Melati Pertiwi", "Adi Putra", "Joko Santoso", "Doni Setiawan", "Lintang Pertiwi", "Septi", "Gopal Pramana", "Tomi Pratama", "Rio Nugraha", "Cindy", "Hafid Saputra", "Hendra", "Niken Lestari", "Rangga Nugroho", "Putri Ayu", "Sofyan Hidayat", "Robby", "Bima Saputra", "Indra", "Adi Kurniawan", "Nanda Saputra", "Gilang Saputra", "Wahyu", "Puspita Ayu", "Rudi Hartono", "Wulan Dewi Pertiwi", "Ayu Pratiwi Lestari", "Tono Adi", "Dedi Kurniawan", "Prasetyo Ramadhan", "Adi Setiawan", "Mira Lestari", "Farhan Syahputra Adi", "Nurul Hidayah", "Sari Anggraini", "Bayu", "Eman", "Putra Adi Nugroho", "Lestari Ayu", "Bambang", "Rangga Hidayat", "Mega Putri", "Adi Nugraha", "Anisa", "Siska", "Wandi Putra", "Fajar Saputra", "Gunawan Pratama", "Heri Setiawan", "Arif", "Ilham Nugroho", "Bagus Pratama", "Erlangga Putra", "Rian", "Pandu", "Tari Ayu", "Hendro", "Risma Ayu", "Adi Pratama", "Septi Ayu", "Bambang Santoso", "Lukman", "Gani Saputra", "Hasan", "Feri Kurniawan", "Tirta", "Bambang Prasetyo", "Pajar Saputra", "Arman Putra", "Murni Ayu", "Hafiz", "Euis Sari", "Bayu Nugroho", "Tomi Saputra", "Gerry Pratama", "Arif Prasetyo", "Johan Putra", "Hafid Nugraha", "Nabila Pertiwi", "Latif Saputra", "Ari Saputra", "Rio Saputra", "Tono Saputra", "Wandi Saputra", "Mahendra Putra", "Ilham Pratama", "Putri Dewi", "Adi Lestari", "Rangga Maulana", "Bayu Hidayat", "Fani Puspita", "Taufik", "Bagus Saputra", "Novi Puspita", "Rahmat Hidayatullah Putra", "Prayitno Saputra", "Adi Ramadhan", "Bayu Wijaya", "Gilang Nugraha", "Rangga Prasetyo", "Putra Purnama", "Wulan Pertiwi", "Adi Wijaya Ramadhan", "Budi", "Rian Pratama", "Samsul Nugroho", "Wahyu Saputra", "Teguh Prasetyo", "Fikri Nugraha", "Rizki Pratama" ];
        
        const testimonialImages = [
            "https://pixvid.org/images/2025/11/04/kS2aB.jpg",
            "https://pixvid.org/images/2025/11/04/kSBPf.jpg",
            "https://pixvid.org/images/2025/11/04/kSBrm.jpg",
            "https://pixvid.org/images/2025/11/04/kSBoz.jpg",
            "https://pixvid.org/images/2025/11/04/kSBXl.jpg",
            "https://pixvid.org/images/2025/11/04/kSNUY.jpg",
            "https://pixvid.org/images/2025/11/04/kSNlo.jpg",
            "https://pixvid.org/images/2025/11/04/kSN6d.jpg",
            "https://pixvid.org/images/2025/11/04/kSNsb.jpg",
            "https://pixvid.org/images/2025/11/04/kScmN.jpg",
            "https://pixvid.org/images/2025/11/04/kSchv.jpg",
            "https://pixvid.org/images/2025/11/04/kSc95.jpg",
            "https://pixvid.org/images/2025/11/04/kScN7.jpg"
        ];
        
        const fullFeaturesList = [
            "<strong>Kapasitas 2TB:</strong> Nikmati penyimpanan raksasa 2TB yang terbagi untuk Google Drive, Google Photos, dan Gmail.",
            "<strong>Akses File Di Mana Saja:</strong> Buka dan edit file Anda dari komputer, tablet, atau smartphone.",
            "<strong>Satu Solusi Terintegrasi:</strong> Semua kebutuhan penyimpanan Anda dalam satu paket hemat.",
            "<strong>Keamanan Kelas Dunia:</strong> File Anda dilindungi oleh infrastruktur keamanan canggih dari Google.",
            "<strong>Berbagi & Kolaborasi Mudah:</strong> Bagikan file dan folder dengan mudah, serta bekerja bersama secara real-time.",
            "<strong>Sekali Bayar Seumur Hidup:</strong> Tanpa biaya langganan bulanan atau tahunan.",
            "<strong>Gunakan Akun Pribadi Anda:</strong> Upgrade dilakukan langsung pada akun Google yang sudah Anda miliki.",
            "<strong>100% Aman & Bergaransi:</strong> Produk asli dengan jaminan privasi penuh."
        ];
        
        const faqList = [
            { q: "Apakah ini benar-benar 2TB dan seumur hidup?", a: "Ya, benar. Anda akan mendapatkan penyimpanan 2TB untuk Google Drive dengan sistem pembayaran sekali untuk selamanya. Tidak ada biaya bulanan atau tahunan tersembunyi." },
            { q: "Bagaimana proses upgrade untuk Google Drive?", a: "Prosesnya otomatis dan terintegrasi dengan akun Google Anda. Setelah pembayaran, penyimpanan pada Google Drive Anda akan langsung ter-upgrade menjadi 2TB. Anda tidak perlu melakukan apa-apa lagi dan bisa langsung menikmati kapasitas 2TB di akun pribadi Anda." },
            { q: "Apakah ini aman dan legal?", a: "Tentu saja. Metode yang kami gunakan adalah sah melalui fitur Google Workspace. Kami tidak pernah meminta password Anda (untuk upgrade Drive) dan privasi file Anda 100% terjamin. Anda memiliki kontrol penuh atas data Anda." },
            { q: "Apa bedanya dengan langganan Google One?", a: "Google One adalah layanan langganan resmi dari Google dengan kuota terbatas (misal 2TB) dan biaya bulanan/tahunan. Produk kami memberikan Anda penyimpanan 2TB dengan sistem sekali bayar untuk selamanya, melalui metode upgrade langsung pada akun Anda." },
            { q: "Bisakah saya memindahkan file lama saya?", a: "Tentu bisa. Karena upgrade ini langsung diterapkan pada akun Google Drive pribadi Anda, semua file lama Anda akan tetap ada di tempatnya dan secara otomatis menjadi bagian dari penyimpanan 2TB yang baru. Anda tidak perlu memindahkan file atau folder apa pun." },
            { q: "Berapa lama proses aktivasinya?", a: "Prosesnya sangat cepat. Setelah Anda melakukan konfirmasi pembayaran, aktivasi biasanya selesai dalam waktu 5-15 menit, maksimal 1x24 jam." },
            { q: "Apakah ada garansi?", a: "Kami memberikan garansi uang kembali penuh jika proses upgrade gagal karena kesalahan dari pihak kami. Kami juga memberikan garansi layanan seumur hidup." },
            { q: "Apakah kapasitas ini mencakup Google Photos dan Gmail?", a: "Ya, penyimpanan 2TB ini bersifat shared storage yang digunakan bersama untuk Google Drive, Google Photos (kualitas asli/original), dan Gmail. Jadi Anda bisa mencadangkan ribuan foto dan video serta ribuan email tanpa khawatir penuh." },
            { q: "Apakah file saya aman dari intipan admin?", a: "100% Aman. Privasi adalah prioritas utama. Sistem kami hanya menambahkan lisensi/kapasitas ke akun Anda. Kami tidak memiliki akses sama sekali ke file, foto, atau email Anda. Hanya Anda yang bisa mengaksesnya." },
            { q: "Apakah ini Shared Drive / Team Drive yang bisa hilang sewaktu-waktu?", a: "Bukan. Ini adalah upgrade pada My Drive (Penyimpanan Utama) akun Anda, bukan sekadar Shared Drive yang seringkali rawan hilang. Karena ini lisensi resmi, maka keamanannya terjamin setara dengan akun Google biasa." },
            { q: "Apakah akun saya berisiko di-banned oleh Google?", a: "Tidak akan. Kami menggunakan metode resmi (Official License) yang mematuhi kebijakan Google. Akun Anda aman dari risiko banned yang biasanya terjadi pada produk ilegal/suntikan." },
            { q: "Apakah bisa digunakan di banyak perangkat?", a: "Sangat bisa. Anda bisa mengakses penyimpanan 2TB ini dari HP (Android/iOS), Tablet/iPad, Laptop (Windows/Mac), maupun PC. Cukup login dengan akun Google yang sama." },
            { q: "Bagaimana jika kapasitas 2TB saya penuh?", a: "Jika 2TB penuh, Anda tidak bisa mengupload file baru atau menerima email masuk (jika Gmail penuh). Namun, Anda bisa menghapus file lama atau menghubungi kami jika ada opsi upgrade lebih lanjut di masa depan." },
            { q: "Apakah saya perlu mengganti akun Google lama saya?", a: "Tidak perlu. Anda cukup mencantumkan alamat email akun Google lama Anda saat pemesanan. Kami akan memproses upgrade langsung di akun tersebut tanpa Anda perlu membuat akun baru." },
            { q: "Apakah ada biaya perpanjangan di tahun berikutnya?", a: "TIDAK ADA. Sesuai janji kami, ini adalah paket Lifetime (Sekali Bayar). Anda cukup membayar satu kali di awal, dan nikmati fitur premium selamanya tanpa tagihan bulanan/tahunan." },
            { q: "Bagaimana cara klaim garansi jika terjadi kendala?", a: "Kami menyediakan support via WhatsApp yang siap membantu. Jika terjadi kendala teknis dari sisi kami yang tidak bisa diselesaikan, kami akan mengembalikan uang Anda 100% atau memberikan unit pengganti." },
            { q: "Berapa lama waktu pengerjaan setelah saya transfer?", a: "Sistem kami bekerja semi-otomatis. Biasanya diproses dalam 5-10 menit saat jam kerja. Paling lambat 1x24 jam jika antrian sedang padat. Pastikan bukti transfer jelas agar verifikasi lebih cepat." }
        ];

        const packages = {
            lifetime: {
                id: 'lifetime',
                name: "Google Drive 2TB (Lifetime)",
                price: 250000,
                normalPrice: 1579000
            }
        };

        const paymentMethods = [
            { id: 'qris', name: 'QRIS', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo_QRIS.svg/163px-Logo_QRIS.svg.png', type: 'qr', number: '00020101021126610016ID.CO.SHOPEE.WWW01189360091800223157700208223157700303UMI51440014ID.CO.QRIS.WWW0215ID10254270621910303UMI5204481453033605802ID5904Epay6013JAKARTA PUSAT61051061062070703A0163042F15' },
            { id: 'bca_va', name: 'BCA', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Bank_Central_Asia.svg/330px-Bank_Central_Asia.svg.png', type: 'bank', number: '39358089510639366', holder: 'Epayment' },
            { id: 'gopay', name: 'GoPay', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Gopay_logo.svg/320px-Gopay_logo.svg.png', type: 'ewallet', number: '089510639366', holder: 'Gopay' },
            { id: 'dana', name: 'DANA', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Logo_dana_blue.svg/330px-Logo_dana_blue.svg.png', type: 'ewallet', number: '089510639366', holder: 'DNID' },
            { id: 'ovo', name: 'OVO', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Logo_ovo_purple.svg/330px-Logo_ovo_purple.svg.png', type: 'ewallet', number: '089510639366', holder: 'OVO' },
            { id: 'cimb', name: 'CIMB', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/CIMB_Niaga_logo.svg/330px-CIMB_Niaga_logo.svg.png', type: 'bank', number: '6289510639366', holder: 'Octo Pay' }
        ];

        const operatorPrefixes = {
            'Telkomsel': ['0811', '0812', '0813', '0821', '0822', '0823', '0851', '0852', '0853'],
            'by.U': ['0851'],
            'Indosat Ooredoo': ['0814', '0815', '0816', '0855', '0856', '0857', '0858'],
            'Tri (3)': ['0895', '0896', '0897', '0898', '0899'],
            'XL Axiata': ['0817', '0818', '0819', '0859', '0877', '0878', '0879'],
            'Live.On': ['0859'],
            'Axis': ['0831', '0832', '0833', '0838'],
            'Smartfren': ['0881', '0882', '0883', '0884', '0885', '0886', '0887', '0888', '0889']
        };
        const blacklistedNumbers = ['081234567890'];
        const allowedEmailDomains = [
            'gmail.com', 'googlemail.com', 'outlook.com', 'hotmail.com',
            'hotmail.co.uk', 'live.com', 'msn.com', 'yahoo.com', 'yahoo.co.id',
            'yahoo.co.uk', 'ymail.com', 'rocketmail.com', 'icloud.com', 'me.com',
            'mac.com', 'aol.com', 'zoho.com', 'proton.me', 'protonmail.com',
            'tutanota.com', 'gmx.com', 'gmx.de', 'mail.com', 'yandex.ru',
            'yandex.com', 'fastmail.com', 'hey.com'
        ];
    
        function isInvalidPattern(nomor) {
            if (blacklistedNumbers.includes(nomor)) return true;
            const numberPart = nomor.substring(2);
            if (/(\d)\1{4,}/.test(numberPart)) return true;
            for (let i = 0; i < numberPart.length - 4; i++) {
                const sub = numberPart.substring(i, i + 5);
                const isAscending = '0123456789'.includes(sub);
                const isDescending = '9876543210'.includes(sub);
                if (isAscending || isDescending) return true;
            }
            const uniqueDigits = new Set(numberPart.split(''));
            if (uniqueDigits.size < 4) return true;
            if (/(..)\1\1/.test(numberPart)) return true;
            return false;
        }
    
        function getOperatorFromNumber(nomor) {
            const prefix = nomor.substring(0, 4);
            for (const operator in operatorPrefixes) {
                if (operatorPrefixes[operator].includes(prefix)) {
                    return operator;
                }
            }
            return null;
        }
    
        function validatePhoneNumber(nomorHp) {
            const genericError = { isValid: false, message: 'Silahkan isi dengan nomor yang benar' };
    
            if (nomorHp.length < 10) {
                return genericError;
            }
    
            const operator = getOperatorFromNumber(nomorHp);
            if (!operator) {
                return genericError;
            }
    
            const maxLength = operator === 'Tri (3)' ? 13 : 12;
            if (nomorHp.length > maxLength) {
                return genericError;
            }
    
            if (isInvalidPattern(nomorHp)) {
                return genericError;
            }
    
            return { isValid: true, message: 'Nomor valid.' };
        }
        let currentPackage = 'lifetime';
        let currentPayment = 'qris';
        let expiryTime;
        let countdownInterval;
        let currentOrderDetails = {};

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPackageCards();
            renderPaymentMethods();
            renderTestimonials();
            renderFAQ();
            updateTotalPrice();
            initNotifications();
            
            // Input formatting
            const whatsappInput = document.getElementById('whatsapp');
            whatsappInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        });

        // --- RENDER FUNCTIONS ---
        function renderPackageCards() {
            const container = document.getElementById('package-selection-container');
            if (!container) return;

            const formatCurrency = (amount) => `Rp ${amount.toLocaleString('id-ID')}`;

            const lifetime = packages.lifetime;
            const discount = Math.round(((lifetime.normalPrice - lifetime.price) / lifetime.normalPrice) * 100);

            // Calculate dynamic quota
            const now = new Date();
            let start = new Date();
            start.setHours(3, 0, 0, 0);
            if (now < start) start.setDate(start.getDate() - 1);
            const elapsed = now - start;
            const duration = 23 * 60 * 60 * 1000; 
            let p = 100 - (elapsed / duration) * 98;
            const quota = Math.floor(Math.max(2, Math.min(100, p)));

            container.innerHTML = `
                <!-- CARD (C1-V3 + tombol Detail) -->
                <article class="relative overflow-hidden rounded-3xl border border-gray-200 bg-white p-5 shadow-[0_18px_60px_-35px_rgba(0,0,0,.25)]">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-3 py-1 text-[11px] font-semibold text-white">
                        <span class="h-2 w-2 rounded-full bg-emerald-400"></span> Ready Stock
                      </div>
                      <h3 class="mt-1 text-lg font-extrabold text-gray-900 leading-tight">Google Drive 2TB (Lifetime)</h3>
                      <p class="mt-1 text-xs text-gray-500">Sisa promo terbatas hari ini</p>
                    </div>
                    <span class="shrink-0 rounded-2xl bg-black px-3 py-1 text-[11px] font-bold text-white">Best</span>
                  </div>

                  <div class="mt-4 rounded-2xl bg-blue-50 p-4 ring-1 ring-blue-100">
                    <div class="flex items-center justify-between">
                      <p class="text-xs text-gray-500">Harga sekarang</p>
                      <p class="text-xs font-semibold text-blue-600">Berakhir 23:59</p>
                    </div>

                    <div class="mt-1 flex items-end justify-between">
                      <p class="text-3xl font-extrabold tracking-tight text-gray-900">${formatCurrency(lifetime.price)}</p>
                      <p class="text-[11px] font-semibold text-gray-400 line-through">${formatCurrency(lifetime.normalPrice)}</p>
                    </div>

                    <div class="mt-3">
                      <div class="flex items-center justify-between text-[11px] text-gray-500">
                        <span>Kuota promo</span>
                        <span class="font-semibold text-gray-800">${quota}% tersisa</span>
                      </div>
                      <div class="mt-2 h-2 overflow-hidden rounded-full bg-gray-200">
                        <div class="h-full rounded-full bg-gradient-to-r from-blue-500 to-blue-600" style="width: ${quota}%"></div>
                      </div>
                    </div>
                  </div>

                  <!-- CTA -->
                  <div class="mt-4 flex gap-2">
                    <button type="button" onclick="document.getElementById('nama').focus()" class="h-12 flex-1 rounded-2xl bg-[#1a73e8] px-5 text-sm font-semibold text-white shadow-lg shadow-blue-600/20 active:scale-[.99] hover:bg-[#1557b0] transition-colors">
                      Ambil Promo
                    </button>

                    <button id="btnDetail"
                      type="button"
                      class="h-12 rounded-2xl bg-white px-4 text-sm font-semibold text-gray-700 ring-1 ring-gray-200 active:scale-[.99]">
                      Detail
                    </button>
                  </div>

                  <p class="mt-3 text-center text-[11px] text-gray-400">
                    Tap <span class="font-semibold text-gray-600">Detail</span> untuk lihat â€œYang kamu dapatâ€
                  </p>
                </article>
            `;
            
            // Init Sheet Logic after render
            initSheetLogic();
        }

        let sheetInitialized = false;

        function initSheetLogic() {
            const sheet = document.getElementById("sheet");
            if(!sheet) return;
            const btnDetail = document.getElementById("btnDetail");
            
            function lockScroll(lock){
              document.documentElement.style.overflow = lock ? "hidden" : "";
              document.body.style.overflow = lock ? "hidden" : "";
            }

            function openSheet(){
              if (!sheet.classList.contains("hidden") && sheet.classList.contains("sheet-open")) return;
              
              sheet.classList.remove("hidden");
              sheet.setAttribute("aria-hidden", "false");
              requestAnimationFrame(() => sheet.classList.add("sheet-open"));
              lockScroll(true);
            }

            if(btnDetail) btnDetail.addEventListener("click", openSheet);

            if (sheetInitialized) return;
            
            const sheetBackdrop = document.getElementById("sheetBackdrop");
            const btnClose = document.getElementById("btnClose");
            const btnOk = document.getElementById("btnOk");
            
            // Populate features
            const listContainer = document.getElementById("sheet-features-list");
            if(listContainer && typeof fullFeaturesList !== 'undefined') {
                listContainer.innerHTML = fullFeaturesList.map(feat => `
                    <li class="flex gap-2">
                        <span class="mt-0.5 grid h-5 w-5 place-items-center rounded-full bg-emerald-100 text-emerald-700 font-bold text-xs shrink-0">âœ“</span>
                        <span class="leading-tight">${feat}</span>
                    </li>
                `).join('');
            }

            function closeSheet(){
              const isActuallyOpen = sheet.classList.contains("sheet-open");
              if (!isActuallyOpen) return;
              
              sheet.classList.remove("sheet-open");
              sheet.setAttribute("aria-hidden", "true");
              setTimeout(() => sheet.classList.add("hidden"), 230);
              lockScroll(false);
            }
            
            if(btnClose) btnClose.addEventListener("click", closeSheet);
            if(btnOk) btnOk.addEventListener("click", closeSheet);
            if(sheetBackdrop) sheetBackdrop.addEventListener("click", closeSheet);

            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && !sheet.classList.contains("hidden")) closeSheet();
            });
            
            sheetInitialized = true;
        }

        function renderTestimonials() {
            const container = document.getElementById('testimonial-container');
            // Duplicate list twice for smoother infinite loop on wide screens
            const images = [...testimonialImages, ...testimonialImages];
            
            container.innerHTML = `
                <div class="testimonial-track">
                    ${images.map(url => `
                        <div class="testimonial-item" onclick="openImageModal('${url}')">
                            <img src="${url}" alt="Testimoni" loading="lazy">
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFAQ() {
            const container = document.getElementById('faq-container');
            container.innerHTML = faqList.map(item => `
                <details class="faq-item">
                    <summary>${item.q}</summary>
                    <div class="faq-content">${item.a}</div>
                </details>
            `).join('');
        }
        
        function showFeaturesModal() {
            const container = document.getElementById('features-list-container');
            container.innerHTML = `<ul class="space-y-3">
                ${fullFeaturesList.map(feat => `
                    <li class="flex items-start gap-3">
                        <i class="fas fa-check-circle text-green-500 mt-1"></i>
                        <span class="text-sm text-gray-700">${feat}</span>
                    </li>
                `).join('')}
            </ul>`;
            
            document.getElementById('featuresModal').classList.add('active');
        }

        function openImageModal(url) {
            document.getElementById('modalImageDisplay').src = url;
            document.getElementById('imageModal').classList.add('active');
        }

        function selectPayment(paymentId) {
            currentPayment = paymentId;
            document.getElementById('selectedPayment').value = paymentId;
            
            // Visual Update
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`pay-opt-${paymentId}`).classList.add('selected');
        }

        function renderPaymentMethods() {
            const grid = document.getElementById('payment-grid');
            grid.innerHTML = paymentMethods.map((pm, idx) => `
                <div id="pay-opt-${pm.id}" class="payment-option ${idx === 0 ? 'selected' : ''}" onclick="selectPayment('${pm.id}')">
                    <img src="${pm.logo}" alt="${pm.name}">
                    <span>${pm.name}</span>
                </div>
            `).join('');
        }

        function updateTotalPrice() {
            const pkgPrice = packages[currentPackage].price;
            const total = pkgPrice + uniqueCode;
            document.getElementById('total-price-display').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        }

        function validateForm() {
            const nameInput = document.getElementById('nama');
            const name = nameInput.value.trim();
            const waInput = document.getElementById('whatsapp');
            const wa = waInput.value.trim();
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!name) return { valid: false, msg: 'Nama wajib diisi', element: nameInput };
            
            const phoneValidationResult = validatePhoneNumber(wa);
            if (!phoneValidationResult.isValid) {
                return { valid: false, msg: phoneValidationResult.message, element: waInput };
            }

            if (!email || !emailRegex.test(email)) {
                return { valid: false, msg: 'Email tidak valid', element: emailInput };
            }

            const domain = email.split('@')[1].toLowerCase();
            if (!allowedEmailDomains.includes(domain)) {
                return { valid: false, msg: 'Domain email tidak diizinkan. Harap gunakan email pribadi.', element: emailInput };
            }
            
            return { valid: true };
        }

        async function handleFormSubmit() {
            const validation = validateForm();
            if (!validation.valid) {
                showModal('Data Belum Lengkap', validation.msg);
                if (validation.element) {
                    validation.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    validation.element.focus();
                }
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Memproses...';

            // Prepare Data
            const formData = new FormData(document.getElementById('orderForm'));
            const pkg = packages[currentPackage];
            const payment = paymentMethods.find(p => p.id === currentPayment);
            const totalPrice = pkg.price + uniqueCode;
            const now = new Date();
            const rL = () => "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random() * 26));
            const rN = () => Math.floor(Math.random() * 10);
            const paymentId = `INV-GDRIVE-${String(now.getFullYear()).slice(-2)}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${rL()}${rN()}${rL()}${rN()}`;
            
            // Prepare Object for Google Script
            const dataToSend = {
                nama: formData.get('nama'),
                whatsapp: formData.get('whatsapp'),
                email: formData.get('email'),
                paket: pkg.name,
                metodePembayaran: payment.name,
                totalTransfer: `Rp${totalPrice.toLocaleString('id-ID')}`,
                idPembayaran: paymentId,
                nomorRekening: payment.number || '-',
                sheetName: formData.get('sheetName')
            };
            
            // Send to Google Script
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                
                // Show Payment Page
                showPaymentPage(dataToSend, payment, totalPrice);
                
            } catch (error) {
                console.error('Error:', error);
                showModal('Error', 'Gagal memproses pesanan. Silakan coba lagi.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Beli Sekarang <i class="fas fa-arrow-right"></i>';
            }
        }

        function showPaymentPage(data, paymentMethod, amount) {
            // Store details for modal
            const pkgDetails = packages[currentPackage];
            currentOrderDetails = {
                pkg: data.paket,
                totalPrice: amount,
                paymentId: data.idPembayaran,
                nama: data.nama,
                whatsapp: data.whatsapp,
                email: data.email,
                price: pkgDetails.price,
                sheetName: data.sheetName
            };

            // Hide Form, Show Payment
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-payment').classList.remove('hidden');
            window.scrollTo(0, 0);

            // Set Timer (24 hours)
            expiryTime = new Date().getTime() + (24 * 60 * 60 * 1000);
            startCountdown();

            // Populate Data
            document.getElementById('payment-amount').innerText = `Rp ${amount.toLocaleString('id-ID')}`;
            document.getElementById('payment-logo-result').src = paymentMethod.logo;

            // Populate invoice summary
            document.getElementById('invoice-details-summary').innerHTML = `
                <span>No. Invoice: <strong>${data.idPembayaran}</strong></span>
                <a href="#" onclick="showDetailsModal(event)" class="font-semibold text-blue-600">Lihat detail</a>
            `;

            // Generate WA Link
            const waMsg = `Halo, saya sudah transfer untuk pesanan:\n` +
                          `No Invoice: ${data.idPembayaran}\n` +
                          `Email: ${data.email}\n` +
                          `Total: ${data.totalTransfer}\n\n` +
                          `Mohon segera diproses.`;
            document.getElementById('wa-confirm-btn').href = `https://wa.me/6285602152097?text=${encodeURIComponent(waMsg)}`;

            // Render Payment Details
            const detailsContainer = document.getElementById('payment-details-content');
            const instructionsContainer = document.getElementById('instruction-steps');
            
            // Raw amount for copy
            const rawAmountInputCheck = document.getElementById('payment-amount-raw');
            if (rawAmountInputCheck) {
                rawAmountInputCheck.value = amount;
            } else {
                const rawAmountInput = document.createElement('input');
                rawAmountInput.type = 'hidden';
                rawAmountInput.id = 'payment-amount-raw';
                rawAmountInput.value = amount;
                document.body.appendChild(rawAmountInput);
            }

            if (paymentMethod.type === 'qr') {
                // Generate QRIS
                try {
                    const qrisStatic = paymentMethod.number;
                    const qrisDynamic = createDynamicQris(qrisStatic, amount);
                    
                    detailsContainer.innerHTML = `
                        <div class="flex flex-col items-center">
                            <div id="qrcode-canvas" class="p-2 border rounded-lg mb-4 bg-white"></div>
                            <button id="download-qris-btn" class="btn-checkout w-auto px-6 py-2 text-sm" style="box-shadow: none; background: var(--secondary); color: var(--text-main); font-weight: 500;">
                                <i class="fas fa-download mr-2"></i> Unduh QRIS
                            </button>
                            <p class="text-xs text-center text-gray-500 mt-4">Scan QR Code diatas dengan aplikasi pembayaran apa saja.</p>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        const qrContainer = document.getElementById('qrcode-canvas');
                        qrContainer.innerHTML = ''; // Clear previous QR
                        const canvas = document.createElement('canvas');
                        QRCode.toCanvas(canvas, qrisDynamic, { width: 200, margin: 1 }, (err) => {
                            if (err) {
                                console.error(err);
                                return;
                            }
                            qrContainer.appendChild(canvas);

                            // Add download functionality
                            document.getElementById('download-qris-btn').addEventListener('click', () => {
                                const link = document.createElement('a');
                                link.download = `QRIS-Pembayaran-${data.idPembayaran}.png`;
                                link.href = canvas.toDataURL('image/png');
                                link.click();
                            });
                        });
                    }, 100);

                    instructionsContainer.innerHTML = `
                        <div class="instruction-step"><div class="step-number">1</div><p class="text-sm">Buka aplikasi e-wallet (GoPay/OVO/Dana) atau Mobile Banking.</p></div>
                        <div class="instruction-step"><div class="step-number">2</div><p class="text-sm">Pilih menu Scan / Bayar.</p></div>
                        <div class="instruction-step"><div class="step-number">3</div><p class="text-sm">Scan QR Code yang muncul di layar.</p></div>
                        <div class="instruction-step"><div class="step-number">4</div><p class="text-sm">Cek nominal (pastikan sama) dan selesaikan pembayaran.</p></div>
                    `;

                } catch (e) {
                    detailsContainer.innerHTML = '<p class="text-red-500">Gagal memuat QRIS.</p>';
                }

            } else {
                // Bank / E-Wallet Number
                detailsContainer.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500">Nomor Rekening / VA</p>
                            <p class="text-lg font-bold text-gray-800 tracking-wide">${paymentMethod.number}</p>
                            <p class="text-xs text-gray-500 mt-1">A.N ${paymentMethod.holder}</p>
                        </div>
                        <button class="copy-btn" onclick="copyText('${paymentMethod.number}')">
                            <i class="far fa-copy"></i> Salin
                        </button>
                    </div>
                `;

                 instructionsContainer.innerHTML = `
                        <div class="instruction-step"><div class="step-number">1</div><p class="text-sm">Buka aplikasi bank atau e-wallet Anda.</p></div>
                        <div class="instruction-step"><div class="step-number">2</div><p class="text-sm">Pilih menu Transfer ke ${paymentMethod.name}.</p></div>
                        <div class="instruction-step"><div class="step-number">3</div><p class="text-sm">Masukkan nomor rekening: <strong>${paymentMethod.number}</strong></p></div>
                        <div class="instruction-step"><div class="step-number">4</div><p class="text-sm">Masukkan nominal <strong>Rp ${amount.toLocaleString('id-ID')}</strong> (harus tepat).</p></div>
                    `;
            }
        }

        function backToForm() {
            document.getElementById('view-payment').classList.add('hidden');
            document.getElementById('view-form').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // --- UTILS ---
        
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = expiryTime - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').innerHTML = "WAKTU HABIS";
                    return;
                }

                const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('countdown').innerHTML = 
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }

        function copyText(textOrId) {
            let text = textOrId;
            const element = document.getElementById(textOrId);
            if (element) text = element.value || element.innerText;

            navigator.clipboard.writeText(text).then(() => {
                showModal('Berhasil', 'Teks berhasil disalin ke clipboard');
            }, () => {
                // Fallback
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showModal('Berhasil', 'Teks berhasil disalin');
                } catch (err) {
                    console.error('Copy failed', err);
                }
                document.body.removeChild(textArea);
            });
        }

        function showModal(title, msg) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = msg;
            const modal = document.getElementById('infoModal');
            modal.classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // Notifications Logic (RESTORED RANDOM NAMES)
        
        function initNotifications() {
            setInterval(() => {
                const name = FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)];
                const toast = document.getElementById('toast');
                document.getElementById('toast-name').innerText = name;
                
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 4000);
            }, 15000 + Math.random() * 10000);
        }

        // --- QRIS GENERATOR UTILS (CRC16) ---
        function createDynamicQris(qris, nominal) {
            let qrisModified = qris.slice(0, -4).replace("010211", "010212");
            const nominalStr = String(Math.round(nominal));
            const amountLength = nominalStr.length < 10 ? "0" + nominalStr.length : nominalStr.length.toString();
            const amountPart = "54" + amountLength + nominalStr;
            
            if (qrisModified.includes("5802ID")) {
                let parts = qrisModified.split("5802ID");
                qrisModified = parts[0] + amountPart + "5802ID" + parts[1];
            } else {
                 // Fallback
            }
            
            // Recalculate CRC
            const crc = crc16ccitt(qrisModified);
            return qrisModified + crc;
        }

        function crc16ccitt(str) {
            let crc = 0xFFFF;
            for (let c = 0; c < str.length; c++) {
                crc ^= str.charCodeAt(c) << 8;
                for (let i = 0; i < 8; i++) {
                    if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
                    else crc = crc << 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, "0");
        }

        function getDetailsModalHTML(details) {
            const { pkg, totalPrice, paymentId, nama, whatsapp, price } = details;
            const uniqueCodeAmount = totalPrice - price;
            return `
                <div class="details-modal-header p-4 flex items-center justify-between">
                    <h3 class="text-lg font-bold">Ringkasan Transaksi</h3>
                    <button onclick="closeModal('detailsModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="details-modal-body p-4 pt-2">
                    <p class="text-xs text-gray-500 mb-3">Nomor Invoice: <strong>${paymentId}</strong></p>
                    <div class="text-center mb-3">
                        <p class="text-sm text-gray-600 mb-1">Total Pembayaran</p>
                        <div class="flex items-center justify-center">
                            <p class="text-3xl font-bold text-gray-900">Rp ${totalPrice.toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                    <div class="space-y-2 border-t border-b border-gray-200 py-3 my-3">
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>${pkg}</span>
                                <span class="font-semibold text-gray-800">Rp ${price.toLocaleString('id-ID')}</span>
                            </div>
                        </div>
                         <div class="flex justify-between text-xs">
                            <span class="text-gray-500">Kode Unik</span>
                            <span class="font-medium">Rp ${uniqueCodeAmount.toLocaleString('id-ID')}</span>
                        </div>
                    </div>
                    <div class="pt-2">
                        <h4 class="font-semibold mb-2 text-sm">Informasi Pelanggan</h4>
                        <div class="space-y-2 text-sm">
                            <div>
                                <p class="text-gray-500 text-xs mb-0.5">Nama</p>
                                <p class="font-medium">${nama}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-xs mb-0.5">Nomor WhatsApp</p>
                                <p class="font-medium">${whatsapp}</p>
                            </div>
                             <div>
                                <p class="text-gray-500 text-xs mb-0.5">Email Gmail</p>
                                <p class="font-medium">${details.email}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showDetailsModal(event) {
            if(event) event.preventDefault();
            const modalContent = document.getElementById('detailsModalContent');
            const modal = document.getElementById('detailsModal');
            
            modalContent.innerHTML = getDetailsModalHTML(currentOrderDetails);
            modal.classList.add('active');
        }

        // --- OCR & PAYMENT VERIFICATION LOGIC ---
        
        let selectedFile = null;

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                // Auto start verification
                await verifyPaymentWithOCR();
            }
        }

        async function verifyPaymentWithOCR() {
            if (!selectedFile) return;

            const scanningState = document.getElementById('ocr-scanning-state');
            const initialState = document.getElementById('ocr-initial-state');

            // UI: Scanning
            // Keep initialState visible to maintain container height/width
            // initialState.classList.add('hidden'); 
            scanningState.classList.remove('hidden');
            
            // Timeout safety
            let worker = null;
            const timeoutId = setTimeout(() => {
                if (worker) worker.terminate();
                showOCRFailure("Waktu habis. Silakan coba lagi.");
            }, 60000); 

            try {
                if (typeof Tesseract === 'undefined') throw new Error("Library missing");

                // Initialize Tesseract (Silent Mode)
                worker = await Tesseract.createWorker("eng", 1, {
                    logger: () => {} // Disable console logs for pro look
                });
                
                const { data: { text } } = await worker.recognize(selectedFile);
                await worker.terminate();
                worker = null;
                clearTimeout(timeoutId);

                // --- MATCHING ---
                let cleanedText = text
                    .replace(/O|o/g, '0')
                    .replace(/I|l/g, '1')
                    .replace(/S|s/g, '5')
                    .replace(/B/g, '8');

                const digitsOnly = cleanedText.replace(/[^0-9]/g, '');
                const expectedAmount = currentOrderDetails.totalPrice.toString();
                
                if (digitsOnly.includes(expectedAmount)) {
                    onPaymentSuccess();
                } else {
                    // Professional Failure Message
                    showOCRFailure("Bukti pembayaran tidak valid. Silakan upload kembali atau verifikasi manual via WhatsApp.");
                }

            } catch (error) {
                clearTimeout(timeoutId);
                console.error(error); 
                showOCRFailure("Gagal memproses gambar. Pastikan format gambar benar (JPG/PNG) dan ukuran tidak terlalu besar.");
            } finally {
                if (worker) await worker.terminate();
            }
        }

        function showOCRFailure(msg) {
            // Reset Box UI
            const scanningState = document.getElementById('ocr-scanning-state');
            const initialState = document.getElementById('ocr-initial-state');
            
            scanningState.classList.add('hidden');
            initialState.classList.remove('hidden'); // Return to upload state
            
            // Show Failure Modal
            document.getElementById('ocrFailureMsg').innerText = msg;
            document.getElementById('ocrFailureModal').classList.add('active');
        }
        
        function retryOCRUpload() {
            closeModal('ocrFailureModal');
            document.getElementById('payment-proof-input').click();
        }

        function onPaymentSuccess() {
             const scanningState = document.getElementById('ocr-scanning-state');
             const initialState = document.getElementById('ocr-initial-state');
             const container = document.getElementById('ocr-container');

             // Stop spinner but don't show result inline
             scanningState.classList.add('hidden');
             
             // Show success styling on the box
             container.classList.add('border-green-500', 'bg-green-50');
             container.classList.remove('border-blue-200', 'hover:bg-blue-50', 'cursor-pointer');
             container.onclick = null; 
             
             // Change initial state icon/text to success statically (optional, but clean)
             initialState.innerHTML = `
                <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-check"></i>
                </div>
                <p class="text-sm font-bold text-green-700">Bukti Terkirim</p>
             `;
             initialState.classList.remove('hidden');

             // Show Success Modal
             document.getElementById('ocrSuccessModal').classList.add('active');
             
             // Send confirmation to backend
             sendPaymentConfirmationToBackend();
        }

        async function sendPaymentConfirmationToBackend() {
            const payload = {
                action: 'confirm_payment',
                idPembayaran: String(currentOrderDetails.paymentId).trim(),
                sheetName: currentOrderDetails.sheetName
            };

            console.log("Sending confirmation payload:", payload);

            try {
                 await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log("Confirmation sent to backend (no-cors mode)");
            } catch (e) {
                console.error("Failed to send confirmation", e);
            }
        }

    </script>
</body>
</html>
